{"version":3,"file":"nov.min.js","sources":["../src/common/tool.js","../src/api/index.js","../src/common/base64.js","../src/index.js"],"sourcesContent":["/**\n * 脚本按需加载\n * @param source\n * @returns {Promise}\n */\nexport function singleLoad(source) {\n    let head = document.getElementsByTagName('head')[0];\n    let script = document.createElement(\"script\")\n    script.type = 'text/javascript'\n    script.src = source\n    script.async = true\n    head.appendChild(script)\n    return new Promise((resolve, reject) => {\n        script.onload = () => {\n            resolve()\n        }\n    })\n}\n\nconst ua = window.navigator.userAgent.toLowerCase()\n/**\n * 是否为微信环境\n * @returns {boolean}\n */\nexport function isWeiXin() {\n    return ua.includes('micromessenger')\n}\n\n/**\n * 是否为iPhone\n * @returns {boolean}\n */\nexport function isIPhone() {\n    /iphone os/.test(ua)\n}\n\n/**\n * 获取URL里的参数\n * @param param\n * @returns {*}\n */\nexport const getUrlParam = (function() {\n    let s = location.search, cache = {};\n    let kvs = s.split(\"?\")[1] ? s.split(\"?\")[1].split(\"&\") : [];\n    kvs.forEach(item => {\n        let o = item.split(\"=\");\n        cache[o[0]] = decodeURIComponent(o[1])\n    })\n\n    return function (param) {\n        return cache[param]\n    }\n})();\n\n/**\n *  Get a cookie value.\n *\n *  @param key The cookie key name.\n */\nexport function getCookie(key) {\n    let i, parts, name, cookie;\n    let result = key ? undefined : '';\n    /* istanbul ignore next */\n    let cookies = (document.cookie || '').split('; ');\n    for (i = 0; i < cookies.length; i++) {\n        parts = cookies[i].split('=');\n        name = parts.shift();\n        cookie = parts.join('=');\n        if (key && key === name) {\n            result = cookie;\n            break;\n        }\n    }\n    return result;\n}\n\nexport const _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n        var source = arguments[i];\n\n        for (var key in source) {\n            if (Object.prototype.hasOwnProperty.call(source, key)) {\n                target[key] = source[key];\n            }\n        }\n    }\n\n    return target;\n};\n","const customApi = '//gw.lenovo.com.cn/service/gateway/wechatJsConf'\n\n/**\n * 获取微信JSSDK签名\n * @returns {Promise}\n */\nexport function getJssdkConfig() {\n    return new Promise(function(resolve, reject) {\n        let xhr = new XMLHttpRequest();\n\n        xhr.addEventListener(\"readystatechange\", function () {\n            if (this.readyState === 4) {\n                resolve(JSON.parse(this.responseText))\n            }\n        });\n        xhr.addEventListener(\"error\", function(error) {\n        \treject(error)\n        })\n\n        xhr.open(\"POST\", customApi);\n        xhr.setRequestHeader(\"Accept\", \"*/*\");\n        xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n\n        xhr.send('url=' + encodeURIComponent(window.location.href.split('#')[0]));\n    })\n}\n","const base64decodechars = [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 62, -1, -1, -1, 63, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, -1, -1, -1, -1, -1, -1, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, -1, -1, -1, -1, -1, -1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, -1, -1, -1, -1, -1];\n\nlet base64decode = function (e) {\n    let t, n, r, i, s, o, u;\n    o = e.length;\n    s = 0;\n    u = \"\";\n\n    while (s < o) {\n        do t = base64decodechars[e.charCodeAt(s++) & 255];\n        while (s < o && t == -1);\n        if (t == -1) break;\n        do n = base64decodechars[e.charCodeAt(s++) & 255];\n        while (s < o && n == -1);\n        if (n == -1) break;\n        u += String.fromCharCode(t << 2 | (n & 48) >> 4);\n        do {\n            r = e.charCodeAt(s++) & 255;\n            if (r == 61) return u;\n            r = base64decodechars[r];\n        } while (s < o && r == -1);\n        if (r == -1) break;\n        u += String.fromCharCode((n & 15) << 4 | (r & 60) >> 2);\n        do {\n            i = e.charCodeAt(s++) & 255;\n            if (i == 61) return u;\n            i = base64decodechars[i];\n        } while (s < o && i == -1);\n        if (i == -1) break;\n        u += String.fromCharCode((r & 3) << 6 | i);\n    }\n    return u;\n};\n\nlet utf8to16 = function (e) {\n    let t = \"\", n = 0, r = e.length, i, s, o;\n    while (n < r) {\n        i = e.charCodeAt(n++);\n        switch (i >> 4) {\n            case 0:\n            case 1:\n            case 2:\n            case 3:\n            case 4:\n            case 5:\n            case 6:\n            case 7:\n                t += e.charAt(n - 1);\n                break;\n            case 12:\n            case 13:\n                s = e.charCodeAt(n++);\n                t += String.fromCharCode((i & 31) << 6 | s & 63);\n                break;\n            case 14:\n                s = e.charCodeAt(n++);\n                o = e.charCodeAt(n++);\n                t += String.fromCharCode((i & 15) << 12 | (s & 63) << 6 | (o & 63) << 0);\n        }\n    }\n    return t;\n};\n\nexport function decode(data) {\n    return utf8to16(base64decode(data));\n}\n","import {_extends, getCookie, getUrlParam, isIPhone, isWeiXin, singleLoad} from \"./common/tool\";\nimport {getJssdkConfig} from \"./api\";\nimport {decode} from \"./common/base64\";\n\nconst config = {\n    jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage'],\n    defaultImage: 'http://driverdl.lenovo.com.cn/FE/static/image/lenovo-share.jpg'\n}\n\nconst LOADED = 'LOADED'\nconst LOGHEAD = '[nov-wechat]'\n\nlet scriptLoad = null, dmp = false\n\nlet pageLoad = new Promise(function(resolve, reject) {\n    //fix Safari font cache bug\n    //https://segmentfault.com/q/1010000007319171/a-1020000007347261\n    if (isIPhone()) {\n        window.addEventListener('load', function() {\n            resolve(LOADED)\n        })\n    } else {\n        resolve('OK')\n    }\n})\n\nfunction setConfig({jsApiList, debugFlag}) {\n    if (!scriptLoad) {\n        scriptLoad = singleLoad('//res.wx.qq.com/open/js/jweixin-1.2.0.js').then(() => {\n            return LOADED\n        })\n    }\n\n    // api config 追加\n    jsApiList.forEach(api => {\n        if (!config.jsApiList.includes(api)) {\n            config.jsApiList.push(api)\n        }\n    })\n\n    return Promise.all([scriptLoad, getJssdkConfig()]).then(values => {\n        let res = values[1]\n\n        wx.config({\n            debug: debugFlag, // 开启调试模式\n            appId: res.data.appId, // 必填，公众号的唯一标识\n            timestamp: res.data.timestamp, // 必填，生成签名的时间戳\n            nonceStr: res.data.noncestr, // 必填，生成签名的随机串\n            signature: res.data.signature,// 必填，签名，见附录1\n            jsApiList: config.jsApiList\n        });\n\n        return new Promise((resolve, reject) => {\n            wx.ready(() => {\n                resolve(wx)\n            })\n            wx.error(error => {\n                reject(error)\n            })\n        })\n    }).catch(error => {\n        return Promise.reject(error)\n    })\n}\n\n/**\n * 设置微信分享\n * 在单页项目，当路由发生变化时，需要更新微信分享设置\n * @param options\n * <ul>\n *  <li>title 标题</li>\n *  <li>imgUrl 分享图片（旧版参数：image）</li>\n *  <li>desc 分享描述（旧版参数：description）</li>\n *  <li>link 分享链接</li>\n *  <li>type 分享类型,music、video或link，不填默认为link</li>\n *  <li>dataUrl 如果type是music或video，则要提供数据链接，默认为空</li>\n *  <li>success</li>\n *  <li>cancel</li>\n * </ul>\n * @returns {Promise<Object>}\n */\nexport const initWechatShare = function (options) {\n    return initWechatJSSDK({jsApiList: config.jsApiList}).then(wx => {\n        let cfg = _extends({\n            desc: options.description,\n            link: options.link || location.href,\n            imgUrl: options.image || config.defaultImage\n        }, options)\n        wx.onMenuShareTimeline(cfg);\n        wx.onMenuShareAppMessage(cfg);\n        return 'ok'\n    })\n}\n\n/**\n * 设置指定的微信 JSSDK 权限\n * @param jsApiList\n * @param debugFlag\n * @returns {Promise}\n */\nexport const initWechatJSSDK = function({jsApiList = config.jsApiList, debugFlag = false}) {\n    if (!isWeiXin()) {\n        return Promise.reject('not wechat')\n    }\n\n    return setConfig({jsApiList, debugFlag})\n}\n\n/**\n * 授权并获取内容，静默仅获取openid，非静默下获取userInfo\n * @param isSilence\n */\nfunction auth(isSilence = true) {\n    let href = window.location.origin + window.location.pathname\n    if (!/.lenovo.com.cn/.test(href)) {\n        console.error(LOGHEAD, '网关不支持除 lenovo.com.cn 以外的域名授权。')\n    } else if (!isWeiXin()) {\n        console.warn(LOGHEAD, '需要在微信下打开窗口')\n    }\n\n    let jumpUrl = ['http://weixin.lenovo.com.cn/service/gateway/']\n\n    let user = getCookie('wxuser'), userInfo = null\n    if (user) {\n        userInfo = decode(user)\n    } else if (!isSilence) {\n        jumpUrl.push('NonsilentAuth?url='+href)\n    }\n\n    let openid = getCookie('openid') || getUrlParam('openid')\n    if (!openid && userInfo) {\n        // 如果有完整的info 信息，就从info 里获取openid\n        try {\n            openid = JSON.parse(userInfo).openid\n        } catch (e) {\n            console.error(LOGHEAD, 'JSON parse error', e)\n        }\n    }\n    if (openid && isSilence) {\n        return openid\n    } else if (isSilence) {\n        jumpUrl.push('AutoAuthorize?url='+href)\n    }\n\n    if (jumpUrl.length > 1) {\n        if (dmp) {\n            window.location.search ? jumpUrl.push(window.location.search + '&dmp=1') : jumpUrl.push('?dmp=1')\n        }\n        pageLoad.then(() => {\n            sessionStorage.setItem('nov-url-hash', window.location.hash)\n            window.location.href = jumpUrl.join('')\n        })\n        return null\n    }\n\n    return isSilence ? openid : userInfo\n}\n\n/**\n * 静默授权，分别从URL里or cookie 里尝试获取openid\n * 需要注意的是，正在执行location jump 时，此刻返回值可能为null，需要在代码里判断返回值的可用性\n * @returns {String}\n */\nexport const getOpenid = function() {\n    return auth(true)\n}\n\n/**\n * 非静默授权，用于获取用户基本信息（即便是未关注的用户）\n * 需要注意的是，正在执行location jump 时，此刻返回值可能为null，需要在代码里判断返回值的可用性\n * @returns {String}\n */\nexport const getUserInfo = function() {\n    return auth(false)\n}\n\n/**\n * 是否是微信浏览器\n * @type {boolean}\n */\nexport const isWeixin = isWeiXin()\n\n/**\n * 是否启用DMP cookie 默认为false\n * @param dmpStatus\n */\nexport const setDmp = function(dmpStatus) {\n\tdmp = dmpStatus\n}\n"],"names":["ua","window","navigator","userAgent","toLowerCase","isWeiXin","includes","s","cache","getUrlParam","location","search","split","forEach","o","item","decodeURIComponent","param","getCookie","key","i","parts","name","cookie","result","undefined","cookies","document","length","shift","join","_extends","Object","assign","target","arguments","source","prototype","hasOwnProperty","call","customApi","base64decodechars","base64decode","e","t","n","r","u","charCodeAt","String","fromCharCode","utf8to16","charAt","config","LOADED","LOGHEAD","scriptLoad","dmp","pageLoad","Promise","resolve","reject","test","addEventListener","setConfig","head","script","jsApiList","debugFlag","getElementsByTagName","createElement","type","src","async","appendChild","onload","then","api","push","all","xhr","XMLHttpRequest","this","readyState","JSON","parse","responseText","error","open","setRequestHeader","send","encodeURIComponent","href","res","values","data","appId","timestamp","noncestr","signature","ready","wx","catch","initWechatJSSDK","auth","isSilence","origin","pathname","warn","jumpUrl","user","userInfo","openid","setItem","hash","isWeixin","options","cfg","description","link","image","defaultImage","onMenuShareTimeline","onMenuShareAppMessage","dmpStatus"],"mappings":"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"}